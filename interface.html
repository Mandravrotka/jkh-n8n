<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Приоритет заявки ЖКХ</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; background: #f5f5f5; }
    textarea, input { width: 100%; margin-bottom: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    button { padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; width: 100%; box-sizing: border-box; }
    button:hover { background: #218838; }
    #result { margin-top: 20px; padding: 20px; background: #fff; border-radius: 4px; min-height: 50px; border-left: 4px solid #28a745; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
    .checkbox-group { display: flex; align-items: center; margin-bottom: 15px; }
    .checkbox-group input { margin-right: 10px; width: 18px; height: 18px; }
    .checkbox-group label { margin-bottom: 0; font-weight: normal; color: #555; }
    h2 { color: #333; border-bottom: 2px solid #28a745; padding-bottom: 10px; }
    .status { font-weight: bold; margin-bottom: 10px; }
    .success { color: #28a745; }
    .error { color: #dc3545; }
    .loading { color: #ffc107; }
    .examples { font-size: 12px; color: #666; margin-top: -5px; margin-bottom: 10px; }
    .example-tag { display: inline-block; background: #e9ecef; padding: 2px 8px; border-radius: 12px; margin-right: 5px; margin-bottom: 5px; font-size: 11px; cursor: pointer; }
    .example-tag:hover { background: #dee2e6; }
  </style>
</head>
<body>
  <h2>Определить приоритет заявки</h2>
  
  <div class="form-group">
    <label for="message">Текст заявки:</label>
    <textarea id="message" placeholder="Опишите проблему..." rows="4">Пахнет газом в подъезде</textarea>
  </div>
  
  <div class="form-group">
    <label for="notes">Примечания к жильцу:</label>
    <div class="examples">
      <span class="example-tag" onclick="insertExample('обычный')">обычный</span>
      <span class="example-tag" onclick="insertExample('пенсионер, проблемы с памятью')">пенсионер, проблемы с памятью</span>
      <span class="example-tag" onclick="insertExample('инвалид, глухонемой')">инвалид, глухонемой</span>
      <span class="example-tag" onclick="insertExample('многодетная семья, проблемная')">многодетная семья, проблемная</span>
    </div>
    <textarea id="notes" placeholder="Введите примечания или выберите из примеров..." rows="2">пенсионер, проблемы с памятью</textarea>
  </div>
  
  <div class="checkbox-group">
    <input type="checkbox" id="explanation" checked>
    <label for="explanation">Получить объяснение к приоритету</label>
  </div>
  
  <button onclick="send()">Определить приоритет</button>
  
  <div id="result">Результат появится здесь</div>

  <script>
    function insertExample(text) {
      document.getElementById('notes').value = text;
    }

    async function send() {
      const resultDiv = document.getElementById('result');
      const explanationCheckbox = document.getElementById('explanation');
      
      resultDiv.innerHTML = '<div class="status loading">⏳ Отправка...</div>';
      resultDiv.style.borderLeftColor = '#ffc107';
      
      try {
        // Получаем текущую дату и время
        const now = new Date();
        const dateStr = now.toLocaleDateString('ru-RU', { 
          day: '2-digit', 
          month: '2-digit', 
          year: 'numeric' 
        });
        const timeStr = now.toLocaleTimeString('ru-RU', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });
        const currentDateTime = `${dateStr} ${timeStr}`;
        
        // Формируем запрос
        const requestData = {
          message: document.getElementById('message').value.trim(),
          resident_notes: document.getElementById('notes').value.trim(),
          currentDateTime: currentDateTime,
          explanation: explanationCheckbox.checked ? "1" : "0"
        };
        
        console.log('Отправляем данные:', requestData);
        
        const response = await fetch('http://localhost:5678/webhook/jkh-priority', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json; charset=utf-8' },
          body: JSON.stringify(requestData)
        });
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        // Красивый вывод JSON
        resultDiv.innerHTML = '<div class="status success">✅ Ответ получен:</div>' + 
                              JSON.stringify(data, null, 2);
        resultDiv.style.borderLeftColor = '#28a745';
        
      } catch (e) {
        resultDiv.innerHTML = '<div class="status error">❌ Ошибка:</div>' + 
                              JSON.stringify({ error: e.message }, null, 2) + 
                              '\n\nУбедитесь, что:\n1. n8n запущен на порту 5678\n2. Workflow настроен правильно';
        resultDiv.style.borderLeftColor = '#dc3545';
      }
    }
  </script>
</body>
</html>